
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>yodapy.datasources.ooi &#8212; yodapy  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for yodapy.datasources.ooi</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">gevent</span>
<span class="kn">import</span> <span class="nn">grequests</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">yodapy.datasources.datasource</span> <span class="k">import</span> <span class="n">DataSource</span>
<span class="kn">from</span> <span class="nn">yodapy.datasources.ooi.helpers</span> <span class="k">import</span> <span class="n">fetch_xr</span><span class="p">,</span> <span class="n">download_all_nc</span>
<span class="kn">from</span> <span class="nn">yodapy.utils.parser</span> <span class="k">import</span> <span class="n">get_nc_urls</span>
<span class="kn">from</span> <span class="nn">yodapy.datasources.ooi.m2m_client</span> <span class="k">import</span> <span class="n">M2MClient</span>

<span class="n">SOURCE_NAME</span> <span class="o">=</span> <span class="s1">&#39;OOI&#39;</span>


<div class="viewcode-block" id="OOI"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI">[docs]</a><span class="k">class</span> <span class="nc">OOI</span><span class="p">(</span><span class="n">DataSource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;OOI Object for Ocean Observatories Initiative Data Retrieval.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        username (str): Username for OOI API Data Access.</span>
<span class="sd">        token (str): Token for OOI API Data Access.</span>
<span class="sd">        source_name (str): Data source name.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OOI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_source_name</span> <span class="o">=</span> <span class="n">SOURCE_NAME</span>

        <span class="n">meta_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;infrastructure&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_pth</span><span class="p">,</span> <span class="s1">&#39;instruments.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_pth</span><span class="p">,</span> <span class="s1">&#39;regions.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_pth</span><span class="p">,</span> <span class="s1">&#39;sites.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_streams_descriptions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_pth</span><span class="p">,</span> <span class="s1">&#39;stream_descriptions.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_streams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_pth</span><span class="p">,</span> <span class="s1">&#39;data_streams.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">M2MClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">api_username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">api_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_urls</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_urls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_type</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;&lt;Data Source: </span><span class="si">{self._source_name}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span><span class="p">)</span>

<div class="viewcode-block" id="OOI.view_instruments"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.view_instruments">[docs]</a>    <span class="k">def</span> <span class="nf">view_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows the current instruments requested.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: Pandas dataframe of the instruments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span></div>

<div class="viewcode-block" id="OOI.view_regions"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.view_regions">[docs]</a>    <span class="k">def</span> <span class="nf">view_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows the regions within OOI.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: Pandas dataframe of the regions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span></div>

<div class="viewcode-block" id="OOI.view_sites"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.view_sites">[docs]</a>    <span class="k">def</span> <span class="nf">view_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows the sites within OOI.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: Pandas dataframe of the sites.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span></div>

<div class="viewcode-block" id="OOI.search"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for desired instruments by region, site, and/or instrument.</span>

<span class="sd">        Args:</span>
<span class="sd">            region (str): **Required** Region name. If multiple use comma separated.</span>
<span class="sd">            site (str): Site name. If multiple use comma separated.</span>
<span class="sd">            node (str): Node name. If multiple use comma separated.</span>
<span class="sd">            instrument (str): Instrument name. If multiple use comma separated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: Modified OOI Object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtered_region</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">filtered_sites</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">filtered_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span>
        <span class="k">if</span> <span class="n">region</span><span class="p">:</span>
            <span class="n">region_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">region</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>  <span class="c1"># noqa</span>
            <span class="n">filtered_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">region_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">region_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
            <span class="n">site_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">site</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>  <span class="c1"># noqa</span>
            <span class="n">filtered_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">site_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">site_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>  <span class="c1"># noqa</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filtered_region</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_region</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">filtered_sites</span> <span class="o">=</span> <span class="n">filtered_sites</span><span class="p">[</span><span class="n">filtered_sites</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_region</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">values</span><span class="p">))]</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
            <span class="n">instrument_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">instrument</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>  <span class="c1"># noqa</span>
            <span class="n">filtered_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">instrument_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">instrument_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filtered_region</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_region</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">filtered_instruments</span> <span class="o">=</span> <span class="n">filtered_instruments</span><span class="p">[</span><span class="n">filtered_instruments</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_region</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">values</span><span class="p">))]</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filtered_sites</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_region</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">filtered_instruments</span> <span class="o">=</span> <span class="n">filtered_instruments</span><span class="p">[</span><span class="n">filtered_instruments</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_sites</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">values</span><span class="p">))]</span>  <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">node_search</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
            <span class="n">filtered_instruments</span> <span class="o">=</span> <span class="n">filtered_instruments</span><span class="p">[</span><span class="n">filtered_instruments</span><span class="o">.</span><span class="n">reference_designator</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">filtered_instruments</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_search</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)]</span>  <span class="c1"># noqa</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span> <span class="o">=</span> <span class="n">filtered_instruments</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OOI.clear"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the instrument filter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: Modified OOI Object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruments</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_retrieve_availibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">stream_type</span><span class="o">=</span><span class="s1">&#39;Science&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves instrument streams availability.</span>
<span class="sd">        Args:</span>
<span class="sd">            inst (DataFrame): Instruments DataFrame.</span>
<span class="sd">            stream_type (str): Stream Type (Engineering, Science, all).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: All the streams for instruments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_streams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inst</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">fetch_instrument_streams</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">reference_designator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stream_type</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">fetch_stream_metadata</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">])[</span><span class="s1">&#39;stream_type&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stream_type</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>  <span class="c1"># noqa</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">preferred_stream</span><span class="p">:</span>
                    <span class="n">filt_st</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">preferred_stream</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>  <span class="c1"># noqa</span>
                    <span class="k">if</span> <span class="n">filt_st</span><span class="p">:</span>
                        <span class="n">all_streams</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">reference_designator</span><span class="p">]</span> <span class="o">=</span> <span class="n">filt_st</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{v.preferred_stream}</span><span class="s1"> NOT FOUND IN </span><span class="si">{v.reference_designator}</span><span class="s1">. Available Streams: </span><span class="si">{st}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{v.reference_designator}</span><span class="s1"> DOES NOT HAVE PREFERRED STREAM!&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{v.reference_designator}</span><span class="s1"> does not have available streams&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>

        <span class="k">return</span> <span class="n">all_streams</span>

    <span class="k">def</span> <span class="nf">_check_data_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;thredds_url&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allURLs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;status_url&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allURLs&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">check_complete</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">urls</span><span class="p">[</span><span class="s1">&#39;status_url&#39;</span><span class="p">],</span> <span class="s1">&#39;status.txt&#39;</span><span class="p">])</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">check_complete</span><span class="p">)</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Your data (</span><span class="si">{urls[&#39;status_url&#39;]}</span><span class="s2">) is still compiling... Please wait.&quot;</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Request (</span><span class="si">{urls[&#39;status_url&#39;]}</span><span class="s2">) completed.&quot;</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="n">urls</span><span class="p">[</span><span class="s1">&#39;thredds_url&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="OOI.data_availability"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.data_availability">[docs]</a>    <span class="k">def</span> <span class="nf">data_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots data availability of desired instruments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Instruments availability dictionary and prints out matplotlib plot of the data availibility.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>

        <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">instruments_avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_availibility</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">rd</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;{inst.set_index(&#39;reference_designator&#39;).at[rd, &#39;name&#39;]} - </span><span class="si">{rd}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># noqa</span>
                    <span class="n">instruments_avail</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">ends</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                        <span class="n">rd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;endTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(),</span>
                        <span class="n">instruments_avail</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">starts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">rd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                        <span class="n">rd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;beginTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(),</span>
                    <span class="n">instruments_avail</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

                <span class="n">edate</span><span class="p">,</span> <span class="n">bdate</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                                <span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">starts</span><span class="p">)]</span>

                <span class="n">ypos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edate</span><span class="p">))</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span> <span class="n">edate</span> <span class="o">-</span> <span class="n">bdate</span><span class="p">,</span>
                        <span class="n">height</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">bdate</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                        <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;OOI Data Availibility Graph&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ypos</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis_date</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">instruments_avail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dataframe is empty...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Please find your desired instruments by using OOI().search() method.&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OOI.request_data"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.request_data">[docs]</a>    <span class="k">def</span> <span class="nf">request_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;netcdf&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request data for filtered instruments.</span>

<span class="sd">        Args:</span>
<span class="sd">            begin_date (str, optional): Begin date of desired data in ISO-8601 Format.</span>
<span class="sd">            end_date (str, optional): End date of desired data in ISO-8601 Format.</span>
<span class="sd">            data_type (str): Desired data type. Either &#39;netcdf&#39; or &#39;json&#39;.</span>
<span class="sd">            limit (int, optional): Desired data points. Required for &#39;json&#39; ``data_type``. Max is 20000.</span>
<span class="sd">            stream (str, optional): Reference designator of stream.</span>
<span class="sd">            **kwargs: Optional Keyword arguments. \n</span>
<span class="sd">                **telemetry** - telemetry type (Default is all telemetry types) \n</span>
<span class="sd">                **time_delta_type** - Type for calculating the subset start time, i.e.: years, months, weeks, days.  Must be a type kwarg accepted by dateutil.relativedelta&#39; \n</span>
<span class="sd">                **time_delta_value** - Positive integer value to subtract from the end time to get the start time for subsetting. \n</span>
<span class="sd">                **time_check** - set to true (default) to ensure the request times fall within the stream data availability \n</span>
<span class="sd">                **exec_dpa** - boolean value specifying whether to execute all data product algorithms to return L1/L2 parameters (Default is True) \n</span>
<span class="sd">                **provenance** - boolean value specifying whether provenance information should be included in the data set (Default is True) \n</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: Modified OOI Object. Use ``raw()`` to see either data url for netcdf or json result for json.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Too many instruments to request data for! Max is 5, you have {len(self._filtered_instruments)}&#39;</span>  <span class="c1"># noqa</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">instrument_avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_availibility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_instruments</span><span class="p">)</span>
        <span class="n">do_filter</span> <span class="o">=</span> <span class="n">instrument_avail</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">stream_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">stream</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
            <span class="n">do_filter</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">inst</span><span class="p">:</span> <span class="n">inst</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">stream_list</span><span class="p">,</span> <span class="n">instrument_avail</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">request_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">inst</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">instrument_to_query</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                                  <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                                                                  <span class="n">stream</span><span class="o">=</span><span class="n">inst</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">],</span>
                                                                                  <span class="n">begin_ts</span><span class="o">=</span><span class="n">begin_date</span><span class="p">,</span>
                                                                                  <span class="n">end_ts</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
                                                                                  <span class="n">application_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                                                                                  <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                                                                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">do_filter</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">request_urls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request_urls</span> <span class="o">=</span> <span class="n">request_urls</span>

        <span class="n">reqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">grequests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">api_username</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">api_token</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">request_urls</span>
                <span class="p">)</span>

        <span class="k">def</span> <span class="nf">exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Requesting data ...&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">grequests</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">reqs</span><span class="p">,</span>
                                <span class="n">exception_handler</span><span class="o">=</span><span class="n">exception_handler</span><span class="p">)</span>

        <span class="n">data_urls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data request complete, please wait for data to be compiled ...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_urls</span> <span class="o">=</span> <span class="n">data_urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_type</span> <span class="o">=</span> <span class="n">data_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OOI.raw"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.raw">[docs]</a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_urls</span></div>

<div class="viewcode-block" id="OOI.check_status"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">turls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_data_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;allURLs&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_urls</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">durl</span> <span class="ow">in</span> <span class="n">filtered_data_urls</span><span class="p">:</span>
            <span class="n">turl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_data_status</span><span class="p">(</span><span class="n">durl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">turl</span><span class="p">:</span>
                <span class="n">turls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turl</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">turls</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data_urls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">turls</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OOI.download_ncfiles"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.download_ncfiles">[docs]</a>    <span class="k">def</span> <span class="nf">download_ncfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">curdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download netcdf files from the catalog created from data request.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder (str, optional): Location to save netcdf file. Default will save in current directory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of exported netcdf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;WARNING: This can possibly take a while for large dataset. Are you sure? (yes | no) :&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_type</span> <span class="o">==</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">:</span>
                <span class="n">turls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_check</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">turls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downloading netcdf data ...&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">turls</span><span class="p">)</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">download_all_nc</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">turls</span><span class="p">]</span>
                    <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self._data_type}</span><span class="s1"> cannot be converted to xarray dataset&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>

        <span class="k">return</span> <span class="n">dataset_list</span></div>

    <span class="k">def</span> <span class="nf">_perform_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">turls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">turls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Time elapsed: </span><span class="si">{delta.seconds}</span><span class="s1">s&#39;</span><span class="p">)</span>
            <span class="n">turls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">turls</span>

<div class="viewcode-block" id="OOI.to_xarray"><a class="viewcode-back" href="../../../modules.html#yodapy.datasources.ooi.OOI.to_xarray">[docs]</a>    <span class="k">def</span> <span class="nf">to_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the OOI streams data and export to Xarray Datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Keyword arguments for xarray open_mfdataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of xarray datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># TODO: What to do when it&#39;s JSON request, calling on to_xarray.</span>
        <span class="c1"># TODO: Standardize the structure of the netCDF to ensure CF compliance.</span>
        <span class="c1"># TODO: Add way to specify instruments to convert to xarray</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_type</span> <span class="o">==</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">:</span>
            <span class="n">turls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_check</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">turls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Acquiring data from opendap urls ...&#39;</span><span class="p">)</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gevent</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">fetch_xr</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">turls</span><span class="p">]</span>
                <span class="n">gevent</span><span class="o">.</span><span class="n">joinall</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{self._data_type}</span><span class="s1"> cannot be converted to xarray dataset&#39;</span><span class="p">)</span>  <span class="c1"># noqa</span>

        <span class="k">return</span> <span class="n">dataset_list</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Landung Setiawan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>